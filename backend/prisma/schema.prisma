// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id       String  @id @default(cuid())
  email    String  @unique
  name     String?
  password String? // Null para login com Google
  googleId String? @unique
  avatar   String?

  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  emailVerified     Boolean @default(false)
  verificationToken String? @unique

  // Relacionamentos
  transactions          Transaction[]
  accounts              Account[]
  budgets               Budget[]
  categories            Category[]
  financialGoals        FinancialGoal[]
  alerts                Alert[]           @relation("UserAlerts")
  recurringTransactions RecurringTransaction[]
  dashboardsOwned       Dashboard[]
  dashboardMemberships  DashboardMember[]
  invitesCreated        DashboardInvite[]      @relation("InviteCreatedBy")
  invitesUsed           DashboardInvite[]      @relation("InviteUsedBy")
  auditLogs             AuditLog[]

  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  NotificationPreferences NotificationPreferences?

  @@index([email])
  @@index([googleId])
  @@map("users")
}

model Transaction {
  id                String   @id @default(cuid())
  date              DateTime
  entryType         String // "Receita" ou "Despesa"
  flowType          String // "Fixa" ou "Variável"
  category          String
  subcategory       String?
  description       String
  amount            Float
  paymentMethod     String?
  institution       String?
  cardBrand         String?
  installmentTotal  Int      @default(0)
  installmentNumber Int      @default(0)
  installmentStatus String   @default("N/A") // "N/A", "Paga", "Pendente"
  notes             String?
  isTemporary       Boolean  @default(false)

  isThirdParty          Boolean @default(false)
  thirdPartyName        String?
  thirdPartyDescription String?

  // Relacionamento com Account (opcional para manter compatibilidade)
  accountId String?
  account   Account? @relation("AccountTransactions", fields: [accountId], references: [id], onDelete: SetNull)

  // Para transferências entre contas
  transferToAccountId  String?
  transferToAccount    Account?     @relation("TransferToAccount", fields: [transferToAccountId], references: [id], onDelete: SetNull)
  linkedTransactionId  String?      @unique
  linkedTransaction    Transaction? @relation("LinkedTransfer", fields: [linkedTransactionId], references: [id])
  linkedTransactionRef Transaction? @relation("LinkedTransfer")

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  dashboardId String
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([entryType])
  @@index([category])
  @@index([institution])
  @@index([userId])
  @@index([dashboardId])
  @@index([accountId])
  @@index([userId, date])
  @@index([userId, category, date])
  @@index([deletedAt])
  @@index([isThirdParty])
  @@map("transactions")
}

enum DashboardRole {
  VIEWER
  EDITOR
  OWNER
}

model Dashboard {
  id          String            @id @default(cuid())
  title       String
  description String?
  ownerId     String
  owner       User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  members     DashboardMember[]
  invites     DashboardInvite[]
  transactions Transaction[]
  alerts      Alert[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@map("dashboards")
}

model DashboardMember {
  id          String        @id @default(cuid())
  dashboardId String
  dashboard   Dashboard     @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        DashboardRole @default(VIEWER)

  createdAt DateTime @default(now())

  @@unique([dashboardId, userId])
  @@map("dashboard_members")
}

model DashboardInvite {
  id          String        @id @default(cuid())
  dashboardId String
  dashboard   Dashboard     @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  code        String        @unique
  role        DashboardRole @default(VIEWER)
  expiresAt   DateTime?
  isOneTime   Boolean       @default(false)
  createdById String
  createdBy   User          @relation("InviteCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  usedById    String?
  usedBy      User?         @relation("InviteUsedBy", fields: [usedById], references: [id])

  createdAt DateTime @default(now())

  @@map("dashboard_invites")
}

// ============================================
// ACCOUNT MODEL - Para gerenciar contas financeiras
// ============================================

enum AccountType {
  CHECKING // Conta corrente
  SAVINGS // Poupança
  CREDIT_CARD // Cartão de crédito
  INVESTMENT // Investimentos
  CASH // Dinheiro
  OTHER // Outros
}

enum AccountStatus {
  ACTIVE
  INACTIVE
  CLOSED
}

model Account {
  id          String      @id @default(cuid())
  name        String // Ex: "Banco XYZ - Conta Corrente"
  type        AccountType
  institution String? // Nome do banco/instituição
  currency    String      @default("BRL")

  // Saldos
  initialBalance   Float  @default(0) // Saldo inicial ao criar a conta
  currentBalance   Float  @default(0) // Calculado automaticamente
  availableBalance Float  @default(0) // Para cartões: limite - usado
  creditLimit      Float? // Limite de crédito (cartões)

  // Controle
  status    AccountStatus @default(ACTIVE)
  isPrimary Boolean       @default(false) // Conta principal

  // Personalização (UI)
  color       String? // Cor para exibição
  icon        String? // Ícone para exibição
  description String? // Descrição adicional

  // Relacionamentos
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[] @relation("AccountTransactions")
  transferFrom Transaction[] @relation("TransferToAccount")

  // Auditoria e Soft Delete
  deletedAt DateTime?
  deletedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([type])
  @@index([userId, isPrimary])
  @@index([deletedAt])
  @@map("accounts")
}

// ============================================
// BUDGET MODEL - Orçamentos
// ============================================

enum BudgetPeriod {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

model Budget {
  id       String       @id @default(cuid())
  name     String
  amount   Float // Limite do orçamento
  period   BudgetPeriod @default(MONTHLY)
  category String? // Categoria específica ou null para geral

  // Período ativo
  startDate DateTime
  endDate   DateTime? // Null = sem fim

  // Alertas
  alertAt Float? // % para alertar (ex: 80 = alerta em 80%)

  // Controle
  isActive Boolean @default(true)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Auditoria
  deletedAt DateTime?
  deletedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, isActive])
  @@index([userId, category])
  @@index([startDate, endDate])
  @@index([deletedAt])
  @@map("budgets")
}

// ============================================
// CATEGORY MODEL - Categorias Estruturadas
// ============================================

model Category {
  id    String  @id @default(cuid())
  name  String
  type  String // "Receita" ou "Despesa"
  icon  String?
  color String?

  // Hierarquia
  parentId String?
  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[] @relation("CategoryTree")

  // Sistema vs Usuário
  isSystem Boolean @default(false) // Categorias padrão do sistema
  userId   String? // null = categoria do sistema
  user     User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Controle
  isActive Boolean @default(true)
  order    Int     @default(0) // Ordem de exibição

  // Auditoria
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, userId, type])
  @@index([type, isActive])
  @@index([userId, isActive])
  @@index([parentId])
  @@index([deletedAt])
  @@map("categories")
}

// ============================================
// FINANCIAL GOAL MODEL - Metas Financeiras
// ============================================

enum GoalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model FinancialGoal {
  id            String  @id @default(cuid())
  name          String
  description   String?
  targetAmount  Float // Valor alvo
  currentAmount Float   @default(0)

  // Prazo
  deadline DateTime?

  // Categoria relacionada (opcional)
  category String?

  // Status
  status GoalStatus @default(ACTIVE)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Controle
  isCompleted Boolean   @default(false)
  completedAt DateTime?

  // Auditoria
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([userId, isCompleted])
  @@index([deadline])
  @@index([deletedAt])
  @@map("financial_goals")
}

// ============================================
// ALERT MODEL - Sistema de Alertas
// ============================================

enum AlertType {
  BUDGET_LIMIT // Orçamento próximo do limite
  BUDGET_EXCEEDED // Orçamento ultrapassado
  LOW_BALANCE // Saldo baixo
  GOAL_ACHIEVED // Meta atingida
  GOAL_DEADLINE // Meta próxima do prazo
  UNUSUAL_SPENDING // Gasto incomum
  RECURRING_DUE // Transação recorrente pendente
  CUSTOM // Alerta customizado
  BUDGET_ALERT
  GOAL_MILESTONE
  LARGE_TRANSACTION
  DASHBOARD_INVITE
  SYSTEM_UPDATE
  PAYMENT_DUE
  RECURRING_TRANSACTION
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
  ERROR
  SUCCESS
}

model Alert {
  id          String        @id @default(cuid())
  type        AlertType
  severity    AlertSeverity @default(INFO)
  title       String
  message     String        @db.Text

  // Dashboard relationship
  dashboardId String
  dashboard   Dashboard     @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  // Dados relacionados
  relatedType String? // "Budget", "Account", "Goal", etc
  relatedId   String?
  metadata    Json? // Dados adicionais

  userId String
  user   User   @relation("UserAlerts", fields: [userId], references: [id], onDelete: Cascade)

  // Controle
  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([dashboardId])
  @@index([userId])
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([type])
  @@index([severity])
  @@index([isRead])
  @@map("alerts")
}

// ============================================
// RECURRING TRANSACTION MODEL - Transações Recorrentes
// ============================================

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  BIMONTHLY
  QUARTERLY
  SEMIANNUALLY
  YEARLY
}

model RecurringTransaction {
  id String @id @default(cuid())

  // Template da transação
  entryType   String // "Receita" ou "Despesa"
  flowType    String // "Fixa" ou "Variável"
  category    String
  subcategory String?
  description String
  amount      Float
  accountId   String?

  // Recorrência
  frequency RecurrenceFrequency
  interval  Int                 @default(1) // A cada X períodos
  startDate DateTime
  endDate   DateTime? // Null = sem fim

  // Controle de execução
  nextDate DateTime // Próxima execução
  lastDate DateTime? // Última execução

  // Controle
  isActive Boolean @default(true)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Auditoria
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, isActive])
  @@index([userId, nextDate])
  @@index([nextDate, isActive])
  @@index([deletedAt])
  @@map("recurring_transactions")
}

// ============================================
// AUDIT LOG MODEL - Auditoria de Segurança
// ============================================

model AuditLog {
  id         String  @id @default(cuid())
  userId     String
  action     String // ex: "CREATE", "UPDATE", "DELETE", "LOGIN"
  resource   String // ex: "Transaction", "Account", "Budget"
  resourceId String? // ID do recurso afetado

  // Detalhes da mudança
  oldValues Json? // Valores antes da alteração
  newValues Json? // Valores depois da alteração
  metadata  Json? // Metadados extras (headers, query params)

  // Rastreamento
  ip         String?
  userAgent  String?
  method     String? // GET, POST, PUT, DELETE
  path       String? // URL acessada
  statusCode Int? // Status da resposta
  duration   Int? // Tempo de execução em ms

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, action])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

model NotificationPreferences {
  id     String @id @default(cuid())
  userId String @unique

  // Email notifications
  emailEnabled           Boolean @default(true)
  emailBudgetAlerts      Boolean @default(true)
  emailGoalMilestones    Boolean @default(true)
  emailWeeklySummary     Boolean @default(true)
  emailMonthlySummary    Boolean @default(true)
  emailLargeTransactions Boolean @default(true)
  emailDashboardInvites  Boolean @default(true)
  emailSystemUpdates     Boolean @default(false)

  // In-app notifications
  inAppEnabled           Boolean @default(true)
  inAppBudgetAlerts      Boolean @default(true)
  inAppGoalMilestones    Boolean @default(true)
  inAppDashboardActivity Boolean @default(true)
  inAppDashboardInvites  Boolean @default(true)

  // Thresholds
  largeTransactionAmount Decimal @default(1000.00) @db.Decimal(10, 2)
  budgetAlertPercentage  Int     @default(80)

  // Frequency
  summaryDay Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

